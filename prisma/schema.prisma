generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id                   String               @id @default(cuid())
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  displayName          String?
  email                String?              @unique
  emailVerifiedAt      DateTime?
  timezone             String               @default("UTC")
  locale               String               @default("en")
  encryptionKeyVersion Int                  @default(1)
  keyRecoveryMethod    String?
  keySalt              Bytes?
  alarmSettings        AlarmSettings?
  categoryProgress     CategoryProgress[]
  censusAnswers        CensusAnswer[]
  consents             Consent[]
  dreamEntries         DreamEntry[]
  events               Event[]
  nightCheckIns        NightCheckIn[]
  promptResponses      PromptResponse[]
  sessions             Session[]
  studyParticipations  StudyParticipation[]

  @@index([email])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  deviceId     String?
  deviceName   String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

model Event {
  id            String   @id @default(cuid())
  userId        String
  type          String
  payload       Json
  timestamp     DateTime @default(now())
  sequence      BigInt   @default(autoincrement())
  aggregateId   String?
  aggregateType String?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([type])
  @@index([timestamp])
  @@index([sequence])
  @@index([aggregateId, aggregateType])
}

model DreamEntry {
  id             String        @id @default(cuid())
  userId         String
  ciphertext     Bytes?
  iv             Bytes?
  keyVersion     Int           @default(1)
  audioUrl       String?
  title          String?
  emotions       String[]
  vividness      Int?
  lucidity       String?
  dreamTypes     String[]
  sleepQuality   Int?
  hoursSlept     Float?
  wakeTime       DateTime?
  wakingLifeLink String?
  capturedAt     DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags           DreamTag[]
  facts          JournalFact[]

  @@index([userId, capturedAt])
  @@index([capturedAt])
}

model JournalFact {
  id              String     @id @default(cuid())
  dreamEntryId    String
  factType        String
  value           Json
  confidence      Float      @default(1.0)
  ontologyVersion Int
  modelVersion    String
  promptVersion   Int
  startIndex      Int?
  endIndex        Int?
  extractedAt     DateTime   @default(now())
  dreamEntry      DreamEntry @relation(fields: [dreamEntryId], references: [id], onDelete: Cascade)

  @@index([dreamEntryId, factType])
  @@index([factType])
  @@index([modelVersion])
}

model Tag {
  id              String     @id @default(cuid())
  name            String
  slug            String     @unique
  category        String
  taxonomyId      String?
  taxonomyVersion Int?
  usageCount      Int        @default(0)
  dreamTags       DreamTag[]

  @@index([category])
  @@index([slug])
}

model DreamTag {
  id           String     @id @default(cuid())
  dreamEntryId String
  tagId        String
  source       String     @default("user")
  createdAt    DateTime   @default(now())
  dreamEntry   DreamEntry @relation(fields: [dreamEntryId], references: [id], onDelete: Cascade)
  tag          Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([dreamEntryId, tagId])
  @@index([tagId])
}

model CensusInstrument {
  id          String          @id @default(cuid())
  slug        String          @unique
  name        String
  description String?
  version     Int             @default(1)
  isActive    Boolean         @default(true)
  isRequired  Boolean         @default(false)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  sections    CensusSection[]

  @@index([isActive, sortOrder])
}

model CensusSection {
  id            String           @id @default(cuid())
  instrumentId  String
  slug          String
  name          String
  description   String?
  icon          String?
  sortOrder     Int              @default(0)
  estimatedTime Int              @default(120)
  questions     CensusQuestion[]
  instrument    CensusInstrument @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@unique([instrumentId, slug])
  @@index([instrumentId, sortOrder])
}

model CensusQuestion {
  id         String         @id @default(cuid())
  sectionId  String
  slug       String
  text       String
  helpText   String?
  type       String
  props      Json
  isRequired Boolean        @default(false)
  validation Json?
  sortOrder  Int            @default(0)
  irtParams  Json?
  groupId    String?
  groupLabel String?
  showWhen   Json?
  answers    CensusAnswer[]
  section    CensusSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, slug])
  @@index([sectionId, sortOrder])
}

model CensusAnswer {
  id                String         @id @default(cuid())
  userId            String
  questionId        String
  value             Json
  instrumentVersion Int            @default(1)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  question          CensusQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
}

model CensusProgress {
  id              String    @id @default(cuid())
  userId          String    @unique
  sectionProgress Json
  totalCompleted  Int       @default(0)
  totalQuestions  Int       @default(0)
  scores          Json?
  lastActivityAt  DateTime  @default(now())
  completedAt     DateTime?

  @@index([userId])
}

model CensusCategory {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  description String?
  icon        String?
  color       String?
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  forms       CensusForm[]

  @@index([sortOrder])
}

model CensusForm {
  id                 String         @id @default(cuid())
  categoryId         String
  slug               String
  name               String
  description        String?
  estimatedMinutes   Int            @default(5)
  sortOrder          Int            @default(0)
  prerequisiteFormId String?
  promptThreshold    Int?
  createdAt          DateTime       @default(now())
  category           CensusCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, slug])
  @@index([categoryId, sortOrder])
}

model CategoryProgress {
  id             String   @id @default(cuid())
  userId         String
  categoryId     String
  promptAnswers  Int      @default(0)
  formsStarted   String[] @default([])
  formsComplete  String[] @default([])
  lastActivityAt DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
}

model Prompt {
  id             String           @id @default(cuid())
  text           String
  type           String
  responseType   String
  responseProps  Json?
  isActive       Boolean          @default(true)
  frequency      String?
  targetingRules Json?
  studyId        String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  study          Study?           @relation(fields: [studyId], references: [id])
  responses      PromptResponse[]

  @@index([isActive])
  @@index([type])
}

model PromptResponse {
  id          String   @id @default(cuid())
  userId      String
  promptId    String
  value       Json
  shownAt     DateTime
  respondedAt DateTime @default(now())
  skipped     Boolean  @default(false)
  prompt      Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, promptId, shownAt])
  @@index([userId])
  @@index([promptId])
  @@index([respondedAt])
}

model Consent {
  id           String   @id @default(cuid())
  userId       String
  scope        String
  version      Int
  granted      Boolean
  timestamp    DateTime @default(now())
  receiptHash  String
  policyHash   String
  jurisdiction String?
  ipHash       String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, scope])
  @@index([scope])
  @@index([timestamp])
}

model WeatherAggregate {
  id            String   @id @default(cuid())
  metric        String
  period        String
  periodStart   DateTime
  value         Json
  sampleN       Int
  dpEpsilon     Float?
  dpDelta       Float?
  minNThreshold Int      @default(50)
  region        String?
  methodVersion Int
  computedAt    DateTime @default(now())

  @@unique([metric, period, periodStart, region])
  @@index([metric])
  @@index([period, periodStart])
  @@index([region])
}

model PersonalWeather {
  id             String   @id @default(cuid())
  userId         String   @unique
  weather        Json
  streaks        Json?
  lastComputedAt DateTime @default(now())

  @@index([userId])
}

model Study {
  id              String               @id @default(cuid())
  slug            String               @unique
  title           String
  description     String
  institution     String?
  dataScope       Json
  duration        String?
  consentText     String
  consentVersion  Int                  @default(1)
  status          String               @default("draft")
  startsAt        DateTime?
  endsAt          DateTime?
  maxParticipants Int?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  prompts         Prompt[]
  participations  StudyParticipation[]

  @@index([status])
  @@index([slug])
}

model StudyParticipation {
  id               String    @id @default(cuid())
  userId           String
  studyId          String
  consentedAt      DateTime  @default(now())
  consentVersion   Int
  status           String    @default("active")
  withdrawnAt      DateTime?
  withdrawalReason String?
  completedAt      DateTime?
  study            Study     @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, studyId])
  @@index([studyId])
  @@index([status])
}

model Emotion {
  id           String    @id @default(cuid())
  name         String
  slug         String    @unique
  valence      Float
  arousal      Float
  parentId     String?
  translations Json?
  version      Int       @default(1)
  parent       Emotion?  @relation("EmotionHierarchy", fields: [parentId], references: [id])
  children     Emotion[] @relation("EmotionHierarchy")

  @@index([slug])
  @@index([parentId])
}

model Symbol {
  id              String  @id @default(cuid())
  name            String
  slug            String  @unique
  category        String
  description     String?
  interpretations Json?
  translations    Json?
  version         Int     @default(1)

  @@index([slug])
  @@index([category])
}

model Theme {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  relatedSlugs String[]
  translations Json?
  version      Int      @default(1)

  @@index([slug])
}

model NightCheckIn {
  id              String   @id @default(cuid())
  userId          String
  date            String
  mood            String?
  dayNotes        String?
  intention       String?
  plannedWakeTime String?
  reminderEnabled Boolean  @default(false)
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model SyncQueueItem {
  id          String    @id @default(cuid())
  userId      String
  operation   String
  resource    String
  payload     Json
  status      String    @default("pending")
  attempts    Int       @default(0)
  lastError   String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId, status])
  @@index([status, createdAt])
}

model AlarmSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  isArmed       Boolean  @default(false)
  schedule      Json     @default("[]")
  soundId       String   @default("gentle-rise")
  volume        Int      @default(80)
  snoozeMinutes Int      @default(9)
  maxSnoozes    Int      @default(3)
  lastSetTime   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
